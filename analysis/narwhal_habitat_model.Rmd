---
title: "narwhal_habitat_model"
author: "Marie Zahn"
date: '2022-12-12'
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = 'C:/Users/marie/Documents/OMG_Narwhals/OMG_narwhals_habitat-model')
```

```{r load packages}
library(tidyverse)
library(corrplot)
library(MuMIn)
library(arm)
library(faraway)
library(ggplot2)
library(sjPlot)
library(here)
```

Open Data
```{r open rdata files}
# reload data from anywhere
load(here('data-cleaning_R/narwhal_model_data.rdata')) # only observations for open-water period (SI < 75%)
load(here('data-cleaning_R/narwhal_model_data_whales.rdata')) # only observations for when narwhals were in the area
```

## Compare detections in 2019

```{r aural and soundtrap detections 2019}
## pool soundtrap and aural detections for 2019 data (i.e., take only one obs/day for each site)
mdl_data_open_water_pooled_2019 <- mdl_data_open_water %>% group_by(site,time) %>% 
  filter(year==2019, narwhal==max(narwhal),(row_number()==n()))

mdl_data_open_water_pooled <- mdl_data_open_water %>% group_by(site,time) %>% 
  filter(narwhal==max(narwhal),(row_number()==n())) %>% dplyr::select(-device)

## identify how many detections from the same day occurred at more than one site
sum(mdl_data_open_water_pooled$narwhal) # total of 93 detections over two years at 3 sites
narwhal_dets <- mdl_data_open_water_pooled %>% filter(narwhal==1) # number of days that narwhals were detected
length(unique(narwhal_dets$time))

mdl_data_open_water_pooled %>% dplyr::select(time, site, narwhal) %>% pivot_wider(names_from = site, values_from = narwhal) %>% mutate(rowsums = kong + rink + sver) %>% filter(rowsums>1)

## tally up total detections for each site for a given year
rink_2018 <- mdl_data_open_water_pooled %>% filter(year==2018, site=='rink')
rink_2019 <- mdl_data_open_water_pooled %>% filter(year==2019, site=='rink')
sum(rink_2018$narwhal)
sum(rink_2019$narwhal)

kong_2018 <- mdl_data_open_water_pooled %>% filter(year==2018, site=='kong')
kong_2019 <- mdl_data_open_water_pooled %>% filter(year==2019, site=='kong')
sum(kong_2018$narwhal)
sum(kong_2019$narwhal)

sver_2018 <- mdl_data_open_water_pooled %>% filter(year==2018, site=='sver')
sum(sver_2018$narwhal)

```

Out of the 77 days that narwhals were detected, only 5 of those days were occasions when whales were detected at two locations on the same day. Whales were never detected at three locations on the same day.

Totals between each year/site

2018
* Rink: 13
* Kong Oscar: 8
* Sverdrup: 7

2019
* Rink: 32
* Kong Oscar: 33


```{r aural vs soundtrap 2019}
## see whether there are any aural detections that were NOT detected by the soundtrap in 2019
aural_2019 <- mdl_data_open_water %>% group_by(site) %>% filter(year==2019,device=='aural') %>% dplyr::select(time,narwhal) %>% rename(narwhal_aural=narwhal)
sound_2019 <- mdl_data_open_water %>% group_by(site) %>%  filter(year==2019,device=='soundtrap') %>% dplyr::select(time,narwhal)%>% rename(narwhal_sound=narwhal)

compare <- aural_2019 %>% group_by(site) %>%  left_join(sound_2019,by="time") %>% filter(site.x==site.y, narwhal_aural==1 &narwhal_sound==0) &narwhal_sound==0
compare

sum(mdl_data_open_water_pooled$narwhal)
mdl_data_open_water %>% filter(year==2018) %>% dplyr::select(narwhal) %>% sum()
mdl_data_open_water %>% filter(year==2019,device=='soundtrap') %>% dplyr::select(narwhal) %>% sum()

## double check using different method
aural_2019_kong <- aural_2019 %>% filter(site=='kong') 
sound_2019_kong <- sound_2019 %>% filter(site=='kong') 
aural_2019_rink <- aural_2019 %>% filter(site=='rink') 
sound_2019_rink <- sound_2019 %>% filter(site=='rink') 

aural_2019_kong %>% left_join(sound_2019_kong,by="time") %>% filter(narwhal_aural==1&narwhal_sound==0)
aural_2019_rink %>% left_join(sound_2019_rink,by="time") %>% filter(narwhal_aural==1&narwhal_sound==0)

```


```{r normalize glacier length data}
## normalize at the start of each year
ref <- mdl_data_open_water_pooled %>% group_by(year, site) %>% filter(time==min(as.Date(time))) %>% dplyr::select(site,year,glacier_length) %>% dplyr::rename(length_ref=glacier_length)

mdl_data_pooled <- mdl_data_open_water_pooled %>% left_join(ref,by=c("site","year")) %>% mutate(glacier_len_std = glacier_length - length_ref)

## sanity check plot
mdl_data_pooled %>% ggplot(aes(x=as.Date(time),y=glacier_len_std,color=site))+
  geom_point()

```

```{r whales only}
# only select period when whales were in the area
# filter all data before these dates
mdl_data_whales2018 <- mdl_data_open_water_pooled %>% filter(year==2018) %>% 
  filter(DOY<285) %>% drop_na()
mdl_data_whales2019 <- mdl_data_open_water_pooled %>% filter(year==2019) %>% 
  filter(DOY>100,DOY<292) %>% drop_na()

mdl_data_pooled_whales <- rbind(mdl_data_whales2018,mdl_data_whales2019)
```


```{r check correlations}

mdl_data_corr <- mdl_data_open_water_pooled %>% ungroup() %>% dplyr::select(!c(narwhal, time, site, year, noise_100Hz, noise_2kHz, runoff_mar)) %>% cor(use = "complete.obs")

mdl_data_corr <- mdl_data_pooled %>% ungroup() %>% dplyr::select(!c(narwhal, time, site, year, noise_100Hz, noise_2kHz, runoff_mar)) %>% cor(use = "complete.obs")

# salt_surf, salt_deep, and temp_deep all correlated with one another and with DOY
# keep DOY and temp_surf
mdl_data_corr <- mdl_data_open_water_pooled %>% ungroup() %>% dplyr::select(!c(narwhal, time, site, year, noise_100Hz, noise_2kHz, velocity, runoff_mar, salt_surf, salt_deep, temp_deep)) %>% cor(use = "complete.obs")

mdl_data_corr <- mdl_data_pooled %>% ungroup() %>% dplyr::select(!c(narwhal, time, site, year, noise_100Hz, noise_2kHz, velocity, runoff_mar, salt_surf, salt_deep, temp_deep)) %>% cor(use = "complete.obs")

# plot correlation test
corrplot::corrplot(mdl_data_corr, method = 'number')

```


## Run models

```{r global glm | pooled detections}
## logistic regression 
## glm with binomial response and logit link 
mdl_global <- glm(narwhal ~
                    temp_surf+
                    ice_cover_percent+
                    runoff_racmo+
                    glacier_length+
                    noise_4kHz+
                    year+
                    DOY+
                    site,
                  # data = mdl_data_open_water_pooled,
                  data = mdl_data_pooled,
                  family=binomial(link="logit"),
                  na.action="na.fail")

# print summary output
summary(mdl_global)
faraway::sumary(mdl_global)

## model using data for time period when whales were in the area
mdl_global_whales <- glm(narwhal ~
                    temp_surf+
                    ice_cover_percent+
                    runoff_racmo+
                    glacier_length+
                    noise_4kHz+
                    as.factor(year)+
                    DOY+
                    site,
                  data = mdl_data_pooled_whales,
                  family=binomial(link="logit"),
                  na.action="na.fail")

# print summary output
summary(mdl_global_whales)
faraway::sumary(mdl_global_whales)
```



```{r}
library(sjPlot)
plot_model(mdl_global_whales)
plot_model(mdl_global_whales, type = 'pred')

 
```


Since we know the soundtrap detected more animals, I will run two separate models: one for all aural detections and one for soundtrap detections.

```{r run glm | separate aural and soundtrap models}
## model for only aural data (2018 and 2019)
## select only aural data
mdl_data_open_water_aural <- mdl_data_open_water %>% filter(device=='aural')

mdl_global_aural <- glm(narwhal ~
                    temp_surf+
                    ice_cover_percent+
                    runoff_racmo+
                    glacier_length+
                    noise_4kHz+
                    year+
                    DOY+
                    site,
                  data = mdl_data_open_water_aural,
                  family=binomial(link="logit"),
                  na.action="na.fail")

# print summary output
summary(mdl_global_aural)
faraway::sumary(mdl_global_aural)

## model for only soundtrap data (2019)
## select only aural data
mdl_data_open_water_soundtrap <- mdl_data_open_water %>% filter(device=='soundtrap')
mdl_data_whales_soundtrap <- mdl_data_whales %>% filter(device=='soundtrap')

mdl_global_soundtrap <- glm(narwhal ~
                    temp_surf+
                    ice_cover_percent+
                    runoff_racmo+
                    glacier_length+
                    noise_4kHz+
                    DOY+
                    site,
                  data = mdl_data_open_water_soundtrap,
                  family=binomial(link="logit"),
                  na.action="na.fail")

# print summary output
summary(mdl_global_soundtrap)
faraway::sumary(mdl_global_soundtrap)

```


Run separate glm for each glacier/site

```{r run glm | model for each site}
## Rink/Fisher ---------------------------------------------
mdl_data_rink <- mdl_data_open_water_pooled %>% filter(site=='rink')
mdl_rink <- glm(narwhal ~
                    temp_surf+
                    ice_cover_percent+
                    runoff_racmo+
                    glacier_length+
                    noise_4kHz+
                    year+
                    DOY,
                  data = mdl_data_rink,
                  family=binomial(link="logit"),
                  na.action="na.fail")
summary(mdl_rink)

## Kong Oscar ----------------------------------------------
mdl_data_kong <- mdl_data_open_water_pooled %>% filter(site=='kong')
mdl_kong <- glm(narwhal ~
                    temp_surf+
                    ice_cover_percent+
                    runoff_racmo+
                    glacier_length+
                    noise_4kHz+
                    year+
                    DOY,
                  data = mdl_data_kong,
                  family=binomial(link="logit"),
                  na.action="na.fail")
summary(mdl_kong)

## Sverdrup ------------------------------------------------
mdl_data_sver <- mdl_data_open_water_pooled %>% filter(site=='sver')
mdl_sver <- glm(narwhal ~
                    temp_surf+
                    ice_cover_percent+
                    runoff_racmo+
                    glacier_length+
                    noise_4kHz+
                    DOY,
                  data = mdl_data_sver,
                  family=binomial(link="logit"),
                  na.action="na.fail")
summary(mdl_sver)

```


## Diagnostics

```{r diagnostics}
## plot deviance residuals------------------------------------------
## set plot area
par(mai = c(0.9, 0.9, 0.1, 0.1),
omi = c(0, 0, 0, 0),
cex.lab = 1)
## plot resids vs eta
binnedplot(fitted(mdl_global), 
           residuals(mdl_global), las = 1, pch = 16,
           ylab = "Residuals", xlab = "Fitted values",main = "")

binnedplot(fitted(mdl_global_whales), 
           residuals(mdl_global_whales), las = 1, pch = 16,
           ylab = "Residuals", xlab = "Fitted values",main = "")

## compute R^2
# deviances
# for open water period
nn <- length(mdl_data_open_water_pooled$time)
DM_mod <- mdl_global$deviance
D0_mod <- mdl_global$null.deviance
# R^2
(R2 <- (1 - exp((DM_mod - D0_mod) / nn)) / (1 - exp(-D0_mod / nn)))

# for period when whales were in the area
nn <- length(mdl_data_pooled_whales$time)
DM_mod <- mdl_global_whales$deviance
D0_mod <- mdl_global_whales$null.deviance
(R2 <- (1 - exp((DM_mod - D0_mod) / nn)) / (1 - exp(-D0_mod / nn)))

## leverages--------------------------------------------------------
## set plot area
par(mai = c(0.9, 1, 0.1, 0.1),
omi = c(0, 0, 0, 0),
cex.lab = 1)
levs <- hatvalues(mdl_global_whales)
## threshhold value
h_crit <- 2 * length(coef(mdl_global_whales)) / nn

## halfnormal plot
faraway::halfnorm(levs, las = 1, ylab = "")
text(0, 0.92*par("usr")[4], substitute(italic(h[crit]) == h_crit, 
                                       list(h_crit = h_crit)), pos = 4)
mtext(side = 2, text = "Sorted Data", line = 4)

## Cook's D---------------------------------------------------------
## set plot area
par(mai = c(0.9, 0.9, 0.1, 0.1),
omi = c(0, 0, 0, 0),
cex.lab = 1)
## halfnormal plot
CD <- cooks.distance(mdl_global_whales)
faraway::halfnorm(CD, las = 1, ylab = "")
mtext(side = 2, text = "Sorted Data", line = 3.5)

## H-L test with 8 groups
# A non-significant p value indicates that there is no evidence that the observed and expected frequencies differ (i.e., evidence of good fit).
library(generalhoslem)
generalhoslem::logitgof(obs = mdl_data_open_water_pooled$narwhal,
                        exp = fitted(mdl_global), g = 8)

generalhoslem::logitgof(obs = mdl_data_pooled_whales$narwhal,
                        exp = fitted(mdl_global_whales), g = 8)
```


```{r dredge, eval=FALSE}
## use dredge function to run all model combinations ======================
dredge_mdl_soundtrap <- dredge(mdl_global_soundtrap)
dredge_mdl_soundtrap

dredge_mdl_aural <- dredge(mdl_global_aural)
dredge_mdl_aural

dredge_mdl <- dredge(mdl_global)
dredge_mdl

dredge_mdl <- dredge(mdl_global_whales)
dredge_mdl

```

```{r check autocorrelation, eval=FALSE}
acf(resid(mdl_global))
acf(resid(mdl_global_whales))
```

